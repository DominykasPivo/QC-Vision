name: CI Pipeline

on:
  push:
  pull_request:

jobs:
  lint-format:
    name: Format + Lint (backend)
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install lint/format tools
        run: |
          python -m pip install --upgrade pip
          pip install black==25.1.0 isort==5.13.2 flake8==7.1.0

      - name: Check formatting (black)
        run: black --check backend

      - name: Check import order (isort)
        run: isort --check-only backend

      - name: Lint (flake8)
        run: flake8 backend


  unit-tests:
    name: Unit tests + Coverage (pytest)
    runs-on: ubuntu-22.04
    needs: [lint-format]

    services:
      minio:
        image: minio/minio:latest
        env:
          MINIO_ROOT_USER: minioadmin
          MINIO_ROOT_PASSWORD: minioadmin
        ports:
          - 9000:9000
          - 9001:9001
        options: >-
          --health-cmd="curl -f http://localhost:9000/minio/health/ready || exit 1"
          --health-interval=5s
          --health-timeout=5s
          --health-retries=30
        command: server /data --console-address ":9001"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install backend deps + pytest
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio

      - name: Run pytest (with coverage)
        working-directory: backend
        env:
          DATABASE_URL: "sqlite:///./test.db"
          MINIO_ENDPOINT: "localhost:9000"
          MINIO_ROOT_USER: "minioadmin"
          MINIO_ROOT_PASSWORD: "minioadmin"
          MINIO_ACCESS_KEY: "minioadmin"
          MINIO_SECRET_KEY: "minioadmin"
          MINIO_BUCKET: "qc-vision-photos"
        run: |
          pytest -q --cov=app --cov-report=term-missing --cov-report=xml

      - name: Upload coverage artifact
        uses: actions/upload-artifact@v4
        with:
          name: coverage-xml
          path: backend/coverage.xml


  smoke:
    name: Smoke test (docker compose + /health)
    runs-on: ubuntu-22.04
    needs: [unit-tests]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create .env for CI (optional)
        run: |
          cat > .env << 'EOF'
          NOCODB_API_TOKEN=
          NOCODB_BASE_ID=
          NOCODB_TABLE_ID=
          EOF

      - name: Start stack
        run: |
          docker compose up -d --build
          docker ps

      - name: Wait for backend health endpoint
        shell: bash
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8000/health > /dev/null; then
              echo "Backend is healthy ✅"
              exit 0
            fi
            echo "Waiting for backend... ($i/30)"
            sleep 2
          done
          echo "Backend failed to become healthy ❌"
          docker compose logs backend
          exit 1

      - name: Tear down
        if: always()
        run: docker compose down -v